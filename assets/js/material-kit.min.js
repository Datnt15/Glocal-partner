var big_image;
var cur_url = window.location.href,
    home_url = document.getElementsByTagName('base')[0].getAttribute('href'),
    bounds = new google.maps.LatLngBounds(),
    infowindow = new google.maps.InfoWindow({maxWidth: 600}),
    map = null,
    markers = [], 
    circles = [], 
    marker_icon = home_url+'assets/img/map_marker.png';
// Toastr setting up
toastr.options = {
  "closeButton": true,
  "debug": false,
  "newestOnTop": true,
  "progressBar": true,
  "positionClass": "toast-top-right",
  "preventDuplicates": false,
  "onclick": null,
  "showDuration": "300",
  "hideDuration": "1000",
  "timeOut": "5000",
  "extendedTimeOut": "1000",
  "showEasing": "swing",
  "hideEasing": "linear",
  "showMethod": "fadeIn",
  "hideMethod": "fadeOut"
}
window.fbAsyncInit = function() {
	FB.init({
	  	appId            : '1865711140423123',
	  	autoLogAppEvents : true,
	  	xfbml            : true,
	  	version          : 'v2.10'
	});
};
(function(d, s, id){
	var js, fjs = d.getElementsByTagName(s)[0];
	if (d.getElementById(id)) {return;}
	js = d.createElement(s); js.id = id;
	js.src = "//connect.facebook.net/en_US/sdk.js";
	fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));

$(document).ready(function() {
    $.material.init();
    window_width = $(window).width();
    $navbar = $('.navbar[color-on-scroll]');
    scroll_distance = $navbar.attr('color-on-scroll') || 500;
    $navbar_collapse = $('.navbar').find('.navbar-collapse');
    $('[data-toggle="tooltip"], [rel="tooltip"]').tooltip();
    if ($(".selectpicker").length != 0) {
        $(".selectpicker").selectpicker()
    }
    $('[data-toggle="popover"]').popover();
    $('.carousel').carousel({
        interval: 3000
    });
    var tagClass = $('.tagsinput').data('color');
    $('.tagsinput').tagsinput({
        tagClass: ' tag-' + tagClass + ' '
    });
    if ($('.navbar-color-on-scroll').length != 0) {
        $(window).on('scroll', materialKit.checkScrollForTransparentNavbar)
    }
    if (window_width >= 768) {
        big_image = $('.page-header[data-parallax="true"]');
        if (big_image.length != 0) {
            $(window).on('scroll', materialKitDemo.checkScrollForParallax)
        }
    }
    
    // Share room on social network
    $(".facebook-share").click(function(e){
    	e.preventDefault();
    	var url = $(this).attr('href');
    	FB.ui(
		{
		  	method: 'share',
		  	href: $(this).attr('href')
		}, function(response){});
    });

    // Booking room handle
    $("#book-form input[name=check-in]").on('dp.change', function(selected){
        if (selected.target.value != moment().format('M/DD/YYYY')) {
            $("#book-form input[name=check-out]").data("DateTimePicker").minDate(selected.date);
            calDaysAndFee($("#book-form input[name=check-in]").data("DateTimePicker").viewDate()._d, $("#book-form input[name=check-out]").data("DateTimePicker").viewDate()._d);
        }
    });

    $("#book-form input[name=check-out]").on('dp.change', function(selected){
        $("#book-form input[name=check-in]").data("DateTimePicker").maxDate(selected.date);
        calDaysAndFee($("#book-form input[name=check-in]").data("DateTimePicker").viewDate()._d, $("#book-form input[name=check-out]").data("DateTimePicker").viewDate()._d);
    });

    // End booking
    $('div[data-toggle="popover"]').popover();

    $("#fill-content-form .collapse").collapse('hide');
    $(".checkbox label input[type=checkbox]").on('change',function(){
        var checkbox = $(this);
        if (checkbox.prop('checked')) {
            checkbox.parents('.checkbox').siblings('.collapse').collapse('show');
        }else{
            checkbox.parents('.checkbox').siblings('.collapse').collapse('hide');
        }
    });

    // Toogle enable between late and soon check
    $(".checkbox label input[name=wanna_check_in_late]").on('change',function(){
        if ($(this).prop('checked')) {
            $(".checkbox label input[name=wanna_check_in_soon").attr('disabled', '');
        }else{
            $(".checkbox label input[name=wanna_check_in_soon").removeAttr('disabled');
        }
    });

    $(".checkbox label input[name=wanna_check_in_soon]").on('change',function(){
        if ($(this).prop('checked')) {
            $(".checkbox label input[name=wanna_check_in_late").attr('disabled', '');
        }else{
            $(".checkbox label input[name=wanna_check_in_late").removeAttr('disabled');
        }
    });

    // Searching room ajax
    $('input[name=room-type]').on('change', function() {
        var _this = $(this);
        $("input[name=all]").prop('checked', false);
        $.post(
            home_url + 'search/search-room-with-filter', 
            {
                room_type   : $('input[name=room-type]:checked').map(function() {return this.value;}).get().join(','),
                accessToken : $("input[name=accessToken]").val()
            }, 
            function(data) {
                handle_search_results(data);
            }
        );
    });


    // Turning to other result page with ajax
    $('#pagination').on('click', 'ul li a', function() {
        var _this = $(this);
        $.post(
            home_url + 'search/search-room-with-filter', 
            {
                page   : _this.attr('data-page'),
                accessToken : $("input[name=accessToken]").val()
            }, 
            function(data) {
                handle_search_results(data);
            }
        );
    });

    // Sarching room meta ajax
    var _meta = ['family', 'kitchen', 'entertainment', 'system', 'room-service'], _data = null;
    _meta.forEach(function(el) {
        $('input[name='+el+']').on('change', function() {
            var _this = $(this);
            switch (el) {
                case 'family':
                    _data = {
                        family : $('input[name='+el+']:checked').map(function() {return this.value;}).get().join(','),
                        accessToken : $("input[name=accessToken]").val()
                    };
                    break;
                case 'kitchen':
                    _data = {
                        kitchen : $('input[name='+el+']:checked').map(function() {return this.value;}).get().join(','),
                        accessToken : $("input[name=accessToken]").val()
                    };
                    break;
                case 'entertainment':
                    _data = {
                        entertainment : $('input[name='+el+']:checked').map(function() {return this.value;}).get().join(','),
                        accessToken : $("input[name=accessToken]").val()
                    };
                    break;
                case 'system':
                    _data = {
                        system : $('input[name='+el+']:checked').map(function() {return this.value;}).get().join(','),
                        accessToken : $("input[name=accessToken]").val()
                    };
                    break;
                case 'room-service':
                    _data = {
                        'room-service' : $('input[name='+el+']:checked').map(function() {return this.value;}).get().join(','),
                        accessToken : $("input[name=accessToken]").val()
                    };
                    break;
            }
            $.post( home_url + 'search/search-room-with-filter', _data, function(data) {
                handle_search_results(data);
            });
        });
    });


    $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
        if(e.target.getAttribute('href') == "#map-view-results"){
            $("#pagination").addClass('hide');
        }else{
            $("#pagination").removeClass('hide');
        }
        
        // e.relatedTarget 
    });
    

    // Define map view
    if ($("#map-view-results").length) {
        initResultsMap();
    }

    function get_all_room_positions(){
        $.get(home_url+'search/get-all-room-positions', function(data) {
            try {
                data = JSON.parse(data);
                if (data.type == 'success') {
                    return data.positions;
                }
            } catch(e) {
                return [];
            }
        });
    }

    function initResultsMap() {
        var glocalHome = {lat: 21.067027, lng: 105.819917};
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 15,
            center: glocalHome
        });
        $.get(home_url+'search/get-all-room-positions', function(data) {
            try {
                data = JSON.parse(data);
                if (data.type == 'success') {
                    deleteMarkers();
                    for (var i = 0; i < data.positions.length; i++) {
                        var marker = new google.maps.Marker({
                            position: {lat: parseFloat(data.positions[i].address.split(',')[0]), lng: parseFloat(data.positions[i].address.split(',')[1]) },
                            animation: google.maps.Animation.DROP,
                            icon: marker_icon,
                            map: map,
                            title: data.positions[i].name
                        });
                        bounds.extend(marker.position);
                        var circle = new google.maps.Circle({
                            map: map,
                            radius: 200,    // 100 metres
                            fillColor: '#00bcd4',
                            strokeColor: '#00bcd5',
                            strokeWeight: 1
                        });
                        circle.bindTo('center', marker, 'position');
                        markers.push(marker);
                        circles.push(circle);
                        marker.addListener('click', function(e) {
                            get_room_info_windows(this.title, map, this);
                        });
                    }
                    map.fitBounds(bounds);
                }
            } catch(e) {
                return [];
            }
        });
    }

    function get_room_info_windows(_room_no, _map, _marker){
        $.post(home_url+'search/get_room_info_window', {room_no: _room_no, accessToken: $("input[name=accessToken]").val()}, function(data) {
            data = JSON.parse(data);
            if (data.type == 'success') {
                infowindow.setContent(data.template);
                infowindow.open(_map, _marker);
            }
        });
    }



    // Sets the map on all markers in the array.
    function setMapOnAll(map) {
        for (var i = 0; i < markers.length; i++) {
            markers[i].setMap(map);
        }
    }

    // Removes the markers from the map, but keeps them in the array.
    function clearMarkers() {
        setMapOnAll(null);
    }

    // Deletes all markers in the array by removing references to them.
    function deleteMarkers() {
        clearMarkers();
        markers = [];
        removeAllcircles();
    }

    function removeAllcircles() {
        for(var i in circles) {
            circles[i].setMap(null);
        }
        circles = []; 
    }
    if (map) {
        
        google.maps.event.addListener(map, 'click', function() {
            infowindow.close();
        });
        google.maps.event.addListener(infowindow, 'domready', function() {

            // Reference to the DIV that wraps the bottom of infowindow
            var iwOuter = $('.gm-style-iw');

            /* Since this div is in a position prior to .gm-div style-iw.
             * We use jQuery and create a iwBackground variable,
             * and took advantage of the existing reference .gm-style-iw for the previous div with .prev().
            */
            var iwBackground = iwOuter.prev();
            iwBackground.css('display', 'none');
            // Moves the infowindow 115px to the right.
            iwOuter.parent().parent().css({left: '100px'});
            // Reference to the div that groups the close button elements.
            var iwCloseBtn = iwOuter.next();

            // Apply the desired effect to the close button
            iwCloseBtn.css({'display' : 'none'});

            // If the content of infowindow not exceed the set maximum height, then the gradient is removed.
            if($('.iw-content').height() < 140){
              $('.iw-bottom-gradient').css({display: 'none'});
            }
            
        });
    }
    

    if(document.getElementById('sliderRefine')){
        var slider2 = document.getElementById('sliderRefine');

        noUiSlider.create(slider2, {
            start: [100, 880],
            connect: true,
            range: {
               'min': [50],
               'max': [1000]
            }
        });

        var limitFieldMin = document.getElementById('price-left');
        var limitFieldMax = document.getElementById('price-right');

        slider2.noUiSlider.on('update', function( values, handle ){
            if (handle){
                limitFieldMax.innerHTML= $('#price-right').data('currency') + Math.round(values[handle]);
            } else {
                limitFieldMin.innerHTML= $('#price-left').data('currency') + Math.round(values[handle]);
            }
        });
        slider2.noUiSlider.on('change', function(){
            var minPrice = limitFieldMin.innerHTML.replace("$", "");
            var maxPrice = limitFieldMax.innerHTML.replace("$", "");
            $.post(
                home_url + 'search/search-room-with-filter', 
                {
                    minTax      : minPrice,
                    maxTax      : maxPrice,
                    accessToken : $("input[name=accessToken]").val()
                }, 
                function(data) {

                    handle_search_results(data);
                }
            );
        });
    }

    
    function handle_search_results(_data){
        try {
            _data = JSON.parse(_data);
            if (_data.type == 'success') {
                $("#grid-view").html(_data.data.rooms_view_grid);
                $("#list-view").html(_data.data.rooms_view_list);
                $("#pagination").html(_data.data.pagination);
                $("#has-result").removeClass('hide');
                $("#not-thing-found").addClass('hide');
                $('html,body').animate({
                    scrollTop: $('.tab-content.tab-space').offset().top - 150
                }, 500);

                // Set map results
                deleteMarkers();
                console.log(_data.data.positions);
                for (var i = 0; i < _data.data.positions.length; i++) {
                    var marker = new google.maps.Marker({
                        position: {
                            lat: parseFloat(_data.data.positions[i].address.split(',')[0]), 
                            lng: parseFloat(_data.data.positions[i].address.split(',')[1]) 
                        },
                        animation: google.maps.Animation.DROP,
                        icon: marker_icon,
                        map: map,
                        title: _data.data.positions[i].name
                    });
                    bounds.extend(marker.position);
                    var circle = new google.maps.Circle({
                        map: map,
                        radius: 200,    // 100 metres
                        fillColor: '#00bcd4',
                        strokeColor: '#00bcd5',
                        strokeWeight: 1
                    });
                    circle.bindTo('center', marker, 'position');
                    markers.push(marker);
                    marker.addListener('click', function(e) {
                        get_room_info_windows(this.title, map, this);
                    });
                }
                map.fitBounds(bounds);
            }else if (_data.type == 'failure') {
                $("#has-result").addClass('hide');
                $("#not-thing-found").removeClass('hide');
            }else{
                console.log(_data);
            }
        } catch(e) {
            console.log(_data);
        }
        
    }

   

});



function calDaysAndFee(start, end){
    var startDate = new Date(start.toLocaleDateString()),
    finish = new Date(end.toLocaleDateString()),
    dayMilliseconds = 1000 * 60 * 60 * 24;

    var weekendDays = 0, normalDays = 0;

    while (startDate <= finish) {
        var day = startDate.getDay()
        if (day == 0 || day == 6) {
            weekendDays++;
        }else{
            normalDays++;
        }
        startDate = new Date(+startDate + dayMilliseconds);
    } 
    $.post(
        home_url + 'room/calc_fee', 
        {
            accessToken : $('#accessToken').val(),
            room_code   : $('#room_code').val(),
            startDate   : start.toLocaleDateString(),
            endDate     : end.toLocaleDateString(),
            weekendDays : weekendDays,
            normalDays  : normalDays
        }, 
        function(data) {
            data = JSON.parse(data);
            if (data.type == 'success') {
                $("#fee_explaination").attr('data-content', data.html);
                $("#fee_explaination").html( "Rent fees " + data.total_night + " night <i class='fa fa-question-circle' aria-hidden='true'></i>");
                $("#rent_fee").text( data.total_rent_rate );
                $("#total_fee").text( data.total_rent_rate );
            }else{
                toastr[data.type](data.msg, data.title);
            }
        }
    );
}
$(window).on("load", function() {
    materialKit.initRotateCard();
    materialKit.initColoredShadows();
    materialKit.initAtvImg();
    materialKit.initFormExtendedDatetimepickers();
});
$(document).on('click', '.card-rotate .btn-rotate', function() {
    var $rotating_card_container = $(this).closest('.rotating-card-container');
    if ($rotating_card_container.hasClass('hover')) {
        $rotating_card_container.removeClass('hover')
    } else {
        $rotating_card_container.addClass('hover')
    }
});
$(document).on('click', '.navbar-toggle', function() {
    $toggle = $(this);
    if (materialKit.misc.navbar_menu_visible == 1) {
        $('html').removeClass('nav-open');
        materialKit.misc.navbar_menu_visible = 0;
        $('#bodyClick').remove();
        setTimeout(function() {
            $toggle.removeClass('toggled')
        }, 550);
        $('html').removeClass('nav-open-absolute')
    } else {
        setTimeout(function() {
            $toggle.addClass('toggled')
        }, 580);
        div = '<div id="bodyClick"></div>';
        $(div).appendTo("body").click(function() {
            $('html').removeClass('nav-open');
            if ($('nav').hasClass('navbar-absolute')) {
                $('html').removeClass('nav-open-absolute')
            }
            materialKit.misc.navbar_menu_visible = 0;
            $('#bodyClick').remove();
            setTimeout(function() {
                $toggle.removeClass('toggled')
            }, 550)
        });
        if ($('nav').hasClass('navbar-absolute')) {
            $('html').addClass('nav-open-absolute')
        }
        $('html').addClass('nav-open');
        materialKit.misc.navbar_menu_visible = 1
    }
});
$(window).on('resize', function() {
    materialKit.initRotateCard();
    materialKit.initFormExtendedDatetimepickers();
});
materialKit = {
    misc: {
        navbar_menu_visible: 0,
        window_width: 0,
        transparent: !0,
        colored_shadows: !0,
        fixedTop: !1,
        navbar_initialized: !1,
        isWindow: document.documentMode || /Edge/.test(navigator.userAgent)
    },
    initAtvImg: function() {
        $('.card-atv').each(function() {
            var $atv_div = $(this).find('.atvImg');
            var $atv_img = $atv_div.find('img');
            var img_src = $atv_img.attr('src');
            var atv_image_layer = '<div class="atvImg-layer" data-img="' + img_src + '"/>';
            $atv_div.css('height', $atv_img.height() + 'px');
            $atv_div.append(atv_image_layer)
        });
        atvImg()
    },
    initColoredShadows: function() {
        if (materialKit.misc.colored_shadows == !0) {
            if (!materialKit.misc.isWindows) {
                $('.card:not([data-colored-shadow="false"]) .card-image').each(function() {
                    var $card_img = $(this);
                    is_on_dark_screen = $(this).closest('.section-dark, .section-image').length;
                    if (is_on_dark_screen == 0) {
                        var img_source = $card_img.find('img').attr('src');
                        var is_rotating = $card_img.closest('.card-rotate').length == 1 ? !0 : !1;
                        var $append_div = $card_img;
                        var colored_shadow_div = $('<div class="colored-shadow"/>');
                        if (is_rotating) {
                            var card_image_height = $card_img.height();
                            var card_image_width = $card_img.width();
                            $(this).find('.back').css({
                                'height': card_image_height + 'px',
                                'width': card_image_width + 'px'
                            });
                            var $append_div = $card_img.find('.front')
                        }
                        colored_shadow_div.css({
                            'background-image': 'url(' + img_source + ')'
                        }).appendTo($append_div);
                        if ($card_img.width() > 700) {
                            colored_shadow_div.addClass('colored-shadow-big')
                        }
                        setTimeout(function() {
                            colored_shadow_div.css('opacity', 1)
                        }, 200)
                    }
                })
            }
        }
    },
    initRotateCard: debounce(function() {
        $('.card-rotate .card-image > .back').each(function() {
            var card_image_height = $(this).parent().height();
            var card_image_width = $(this).parent().width();
            $(this).css({
                'height': card_image_height + 'px',
                'width': card_image_width + 'px'
            });
            if ($(this).hasClass('back-background')) {
                var img_src = $(this).siblings('.front').find('img').attr('src');
                $(this).css('background-image', 'url("' + img_src + '")')
            }
        })
    }, 17),
    checkScrollForTransparentNavbar: debounce(function() {
        if ($(document).scrollTop() > scroll_distance) {
            if (materialKit.misc.transparent) {
                materialKit.misc.transparent = !1;
                $('.navbar-color-on-scroll').removeClass('navbar-transparent');
                $(".navbar-color-on-scroll .container .navbar-header .navbar-brand img").attr('src', 'assets/img/logo.png');

            }
        } else {
            if (!materialKit.misc.transparent) {
                materialKit.misc.transparent = !0;
                $('.navbar-color-on-scroll').addClass('navbar-transparent');
                $(".navbar-color-on-scroll .container .navbar-header .navbar-brand img").attr('src', 'assets/img/logo-white.png');
            }
        }
    }, 17),
    initFormExtendedDatetimepickers: function() {
        $('.datetimepicker').datetimepicker({
            icons: {
                time: "fa fa-clock-o",
                date: "fa fa-calendar",
                up: "fa fa-chevron-up",
                down: "fa fa-chevron-down",
                previous: 'fa fa-chevron-left',
                next: 'fa fa-chevron-right',
                today: 'fa fa-screenshot',
                clear: 'fa fa-trash',
                close: 'fa fa-remove',
                inline: !0
            },
            minDate: new Date()
        });
        $('.datepicker').datetimepicker({
            format: 'M/DD/YYYY',
            icons: {
                time: "fa fa-clock-o",
                date: "fa fa-calendar",
                up: "fa fa-chevron-up",
                down: "fa fa-chevron-down",
                previous: 'fa fa-chevron-left',
                next: 'fa fa-chevron-right',
                today: 'fa fa-screenshot',
                clear: 'fa fa-trash',
                close: 'fa fa-remove',
                inline: !0
            },
            minDate: new Date()
        });
        $('.timepicker').datetimepicker({
            format: 'h:mm A',
            icons: {
                time: "fa fa-clock-o",
                date: "fa fa-calendar",
                up: "fa fa-chevron-up",
                down: "fa fa-chevron-down",
                previous: 'fa fa-chevron-left',
                next: 'fa fa-chevron-right',
                today: 'fa fa-screenshot',
                clear: 'fa fa-trash',
                close: 'fa fa-remove',
                inline: !0
            }
        });
        $( "#show_months" ).datepicker({
			numberOfMonths: 3,
			showButtonPanel: false
		});
    },
    // initSliders: function() {
    //     var slider = document.getElementById('sliderRegular');
    //     noUiSlider.create(slider, {
    //         start: 40,
    //         connect: [!0, !1],
    //         range: {
    //             min: 0,
    //             max: 100
    //         }
    //     });
    //     var slider2 = document.getElementById('sliderDouble');
    //     noUiSlider.create(slider2, {
    //         start: [20, 60],
    //         connect: !0,
    //         range: {
    //             min: 0,
    //             max: 100
    //         }
    //     })
    // }
}
materialKitDemo = {
    checkScrollForParallax: debounce(function() {
        if (isElementInViewport(big_image)) {
            var current_scroll = $(this).scrollTop();
            oVal = ($(window).scrollTop() / 3);
            big_image.css({
                'transform': 'translate3d(0,' + oVal + 'px,0)',
                '-webkit-transform': 'translate3d(0,' + oVal + 'px,0)',
                '-ms-transform': 'translate3d(0,' + oVal + 'px,0)',
                '-o-transform': 'translate3d(0,' + oVal + 'px,0)'
            })
        }
    }, 4)
}

function debounce(func, wait, immediate) {
    var timeout;
    return function() {
        var context = this,
            args = arguments;
        clearTimeout(timeout);
        timeout = setTimeout(function() {
            timeout = null;
            if (!immediate) func.apply(context, args)
        }, wait);
        if (immediate && !timeout) func.apply(context, args)
    }
};

function isElementInViewport(elem) {
    var $elem = $(elem);
    var scrollElem = ((navigator.userAgent.toLowerCase().indexOf('webkit') != -1) ? 'body' : 'html');
    var viewportTop = $(scrollElem).scrollTop();
    var viewportBottom = viewportTop + $(window).height();
    var elemTop = Math.round($elem.offset().top);
    var elemBottom = elemTop + $elem.height();
    return ((elemTop < viewportBottom) && (elemBottom > viewportTop))
}
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-46172202-1']);
_gaq.push(['_trackPageview']);
(function() {
    var ga = document.createElement('script');
    ga.type = 'text/javascript';
    ga.async = !0;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(ga, s)
})()